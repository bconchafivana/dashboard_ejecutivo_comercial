 with owners_ok as (
SELECT
    docs.cesion_owner, count(*),
    MAX(docs.cesion_owner_name_fixed) OVER (PARTITION BY docs.cesion_owner_name_fixed) AS cesion_owner_name_fixed,
    MAX(docs.cesion_owner_name) OVER (PARTITION BY docs.cesion_owner) AS cesion_owner_name
FROM
    (
        SELECT
            d.cesion_owner,
            CASE WHEN d.cesion_owner IN ('99595990-9', '76146246-6', '76261789-7', '96626570-1')
                THEN 'LATAM TRADE CAPITAL S.A'
                ELSE cesion_owner_name END AS cesion_owner_name_fixed, 
            d.cesion_owner_name
        FROM
            fc_documents d
        WHERE
            year(FROM_UNIXTIME(d.emission)) > 2022 AND d.cesion_owner IS NOT NULL
         --    and d.cesion_owner = '77218874-9'
    ) docs
GROUP BY
    docs.cesion_owner
    )
select
    d.document_id,
    d.document_type,
    d.no_reception_doc,
    d.client_rut,
    d.folio, 
    d.debtor_rut,
    d.custom_expiration_utc,
    d.applied_base_rate,
    d.applied_finance_percent,
    d.backoffice_status,
    d.paid_amount,
    FROM_UNIXTIME(d.emission) AS emision,
    DATEDIFF(FROM_UNIXTIME(d.emission),CURDATE()) AS EMIDIFF,
    d.status_resale,
    d.finance_amount,
    d.reseller_status,
    d.has_annulment_nc,
    d.sii_reclaimed,
    d.debtor_name,
    d.debtor_category,
    d.confirmation_verification_date,
    d.confirmation_verification_state,
    d.reseller_investor_name,
    d.collect_executive_id,
    d.last_management,
    d.next_management_date,
    d.last_payment_date,
    d.financed_balance,
    d.amount,
    d.sii_executive_merit,
    d.client_name,
    FROM_UNIXTIME(d.expiration)  AS expiration,
    d.original_amount,
    d.comercial_executive_id,
    d.abonado_date_utc,
    d.last_management_date,
    d.document_type_description,
    d.published_client_dicom,
    d.published_debtor_dicom,
    d.has_amount_nc,
    d.has_text_nc,
    d.judicial_cause_id,
    d.judicial_cause_status,
    d.date_annulment_nc,
    d.status, 
    datediff(curdate(), FROM_UNIXTIME(d.expiration)) as delta_doc_expiration,
    datediff(CURDATE(), d.custom_expiration_utc)  as delta_ltc_expiration,
    case when d.status in (2,3) and d.backoffice_status <> 'Cas' then "Cartera"
    else "Global" end as cartera_global, 
    case when datediff(CURDATE(), d.custom_expiration_utc) <= 0 then '5. Vigente'
         when datediff(CURDATE(), d.custom_expiration_utc) <= 30 and  datediff(CURDATE(), d.custom_expiration_utc) >0 then '4. M 30'
         when datediff(CURDATE(), d.custom_expiration_utc) <= 60 and  datediff(CURDATE(), d.custom_expiration_utc) >30 then '3. M 60'
         when datediff(CURDATE(), d.custom_expiration_utc) <= 90 and  datediff(CURDATE(), d.custom_expiration_utc) >0 then '2. M 90'
         when datediff(CURDATE(), d.custom_expiration_utc) > 90 then '1. M +90'end as  distribution_mora,
    o.cesion_owner_name,
    o.cesion_owner,
    CASE WHEN o.cesion_owner IN ('99595990-9', '76146246-6', '76261789-7', '96626570-1') AND d.status IN (2,3) THEN o.cesion_owner_name_fixed
    	ELSE o.cesion_owner_name END AS factor_owner_name, 
    case when o.cesion_owner IN ('99595990-9', '76146246-6', '76261789-7', '96626570-1') AND d.status IN (2,3) then d.amount
    	else 0 end as Latam,
    case when o.cesion_owner is not null and o.cesion_owner not in ('99595990-9', '76146246-6', '76261789-7', '96626570-1') then d.amount
    	else 0 end as Cedido,
    case when o.cesion_owner Is null then d.amount
    	else 0 end as `Free`, 
  case d.document_type
            when 30 then 'FF' -- 
            when 33 then 'FA' -- Factura de Venta
            when 34 then 'FE' -- Factura de Venta sin IVA
            when 46 then 'FC' -- Factura de Compra
            when 601 then 'MF' -- Microfinanciamiento
			when 701 then 'AP' -- Acuerdo de Pago
            when 801 then 'OC' -- Orden de Compra
            when 803 then 'CT' -- Contrato
            when 901 then 'CH' -- Cheque
            when 902 then 'PA' -- Pagar√©
            else d.document_type
    end as document_type_name, 
      d.amount, c.sii_connected ,
      year(FROM_UNIXTIME(d.emission))*100 + month(FROM_UNIXTIME(d.emission)) as yearmonth_emission 
from fc_documents d
left join owners_ok o ON o.cesion_owner = d.cesion_owner  
left join fc_customers c on c.customer_id = d.client_rut
WHERE  (deleted is null or deleted = 0)  and   ((d.status = 2 and d.backoffice_status <> 'Cas' ) or 
(MONTH(FROM_UNIXTIME(d.emission)) BETWEEN MONTH(CURDATE()) - 12 AND MONTH(CURDATE())))
